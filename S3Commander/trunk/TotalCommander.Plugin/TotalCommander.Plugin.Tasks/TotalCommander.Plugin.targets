<?xml version="1.0" encoding="utf-8" ?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <UsingTask TaskName="TotalCommander.Plugin.Tasks.DllExport" AssemblyFile="TotalCommander.Plugin.Tasks.dll"/>
  <UsingTask TaskName="TotalCommander.Plugin.Tasks.ILDasm" AssemblyFile="TotalCommander.Plugin.Tasks.dll"/>
  <UsingTask TaskName="TotalCommander.Plugin.Tasks.ILAsm" AssemblyFile="TotalCommander.Plugin.Tasks.dll"/>
  <UsingTask TaskName="TotalCommander.Plugin.Tasks.RC" AssemblyFile="TotalCommander.Plugin.Tasks.dll"/>

  <Target Name="GenerateTotalCommanderWfxPlugin">
    <CreateProperty Value="wfx">
      <Output PropertyName="PluginType" TaskParameter="Value"/>
    </CreateProperty>

    <CallTarget Targets="GenerateTotalCommanderPlugin"/>
  </Target>

  <Target Name="GenerateTotalCommanderWcxPlugin">
    <CreateProperty Value="wcx">
      <Output PropertyName="PluginType" TaskParameter="Value"/>
    </CreateProperty>
    <Message Text="PluginType: $(PluginType)" Importance="high"/>

    <CallTarget Targets="GenerateTotalCommanderPlugin"/>
  </Target>

  <Target Name="GenerateTotalCommanderPlugin">
    <ILDasm Source="TotalCommander.Plugin.Exports.dll" OutputIL="$(TargetDir)TotalCommander.Plugin.Exports.il">
      <Output TaskParameter="OutputIL" PropertyName="OutputIL"/>
    </ILDasm>

    <DllExport Source="$(OutputIL)" />

    <Copy SourceFiles="$(ApplicationIcon)" DestinationFolder="$(TargetDir)" Condition=" '$(ApplicationIcon)' != '' "/>
    <WriteLinesToFile File="$(TargetDir)$(TargetName).rc" Lines="1 ICON $(ApplicationIcon)" Overwrite="true" Condition=" '$(ApplicationIcon)' != '' "/>
    <RC Source="$(TargetDir)$(TargetName).rc" Condition=" '$(ApplicationIcon)' != '' ">
      <Output TaskParameter="Output" PropertyName="OutputRes"/>
    </RC>

    <Message Text="PluginType: $(PluginType)" Importance="high"/>
    <ILAsm Source="$(OutputIL)" Resource="$(OutputRes)" Output="$(TargetDir)$(TargetName).$(PluginType)"/>

    <Delete Files="$(TargetDir)$(ApplicationIcon);$(TargetDir)TotalCommander.Plugin.Exports.il;$(TargetDir)TotalCommander.Plugin.Exports.res;$(TargetDir)$(TargetName).rc;$(TargetDir)$(TargetName).res"
            ContinueOnError="true"/>
  </Target>

</Project>
